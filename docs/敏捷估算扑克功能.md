# 敏捷估算扑克功能说明

## 功能概述

敏捷估算扑克是项目管理系统中的一个核心功能模块，用于团队对用户故事进行相对估算。该功能通过模拟真实扑克牌的方式，让团队成员对用户故事的工作量进行匿名估算，然后揭示并讨论不同估算结果，最终达成共识并确定用户故事的故事点数。

## 功能结构

敏捷估算扑克功能主要由以下几个部分组成：

1. **估算列表** - 显示所有用户故事及其估算状态
2. **估算房间** - 团队成员进行估算扑克的界面
3. **等待界面** - 成员出牌后等待其他人完成的界面
4. **揭示结果** - 展示所有成员估算结果和统计信息的界面
5. **估算历史** - 查看历史估算记录的界面

## 核心功能

### 1. 估算列表

估算列表页面展示所有用户故事及其估算状态，主要功能包括：

- 分页显示所有用户故事
- 显示每个用户故事的估算状态（未开始/进行中）
- 显示已出牌人员名单
- 显示用户故事的故事点数（来自SprintBacklog）
- 提供开始估算和亮牌操作按钮

每个用户故事显示以下信息：
- 序号
- 用户故事标题和描述
- 故事点数（如果已估算）
- 估算进度（未开始/进行中）
- 已出牌人员列表
- 操作按钮（开始估算、亮牌）

### 2. 估算房间

估算房间是团队成员进行估算扑克的核心界面：

- 显示当前估算的用户故事标题
- 展示团队成员出牌状态（未选择、已选择但未揭示、已揭示）
- 提供扑克牌选择按钮（0, 1, 2, 3, 5, 8, 13, 21, 34, 55, '?', '∞', 'coffee'）
- 管理员可以揭示结果

成员出牌状态标识：
- 未选择：显示"-"符号
- 已选择但未揭示：显示"✓"符号
- 已揭示：显示具体选择的牌面值

### 3. 等待界面

等待界面显示在成员出牌后：

- 显示所有团队成员的出牌状态
- 当所有成员都完成出牌后，自动跳转到揭示结果页面
- 管理员可以手动揭示结果

### 4. 揭示结果

揭示结果页面展示所有成员的估算结果和统计信息：

- 显示所有成员选择的牌面值
- 展示统计信息：
  - 参与人数
  - 平均值
  - 共识状态（基于多数投票算法）
  - 数值分布情况
- 当达成共识时，显示保存故事点按钮
- 提供开始下一轮和返回房间操作

共识计算算法：
- 使用多数投票方法（动态阈值）
- 根据参与人数动态调整阈值：
  - 2-3人团队：50%阈值
  - 4-5人团队：60%阈值
  - 6人及以上团队：70%阈值

### 5. 保存故事点

当团队成员的估算达成共识时，系统允许保存故事点：

- 自动计算推荐的故事点值（达成共识的值）
- 点击保存按钮时弹出确认对话框
- 确认后将故事点保存到SprintBacklog的story_points字段
- 保存成功后结束当前估算回合

### 6. 估算历史

估算历史页面展示历史估算记录：

- 分页显示历史估算信息
- 可查看过去的估算结果和统计信息

## 技术实现

### 后端实现

#### 路由和控制器
估算功能由 `routes/estimation.py` 文件实现，主要包括以下路由：

1. `/estimate` - 显示估算列表页面
2. `/start_estimate/<int:user_story_id>` - 开始对指定用户故事进行估算
3. `/poker` - 显示估算房间页面
4. `/wait` - 显示等待页面
5. `/reveal` - 显示揭示结果页面
6. `/save_story_points` - 保存故事点数
7. `/new_round` - 开始下一轮估算

#### 数据处理
估算功能涉及以下模型：
- UserStory（用户故事）
- GameRound（估算回合）
- Estimate（估算记录）
- SprintBacklog（冲刺待办事项）
- User（用户）

#### 共识算法
系统通过多数投票方法计算共识：
1. 统计每个估算值的选择次数
2. 根据参与人数动态确定阈值
3. 检查得票最多的值是否超过阈值
4. 如果超过阈值则认为达成共识

#### 故事点保存
系统将达成共识的估算值保存到SprintBacklog模型的story_points字段：
1. 优先查找用户故事关联的进行中冲刺的待办事项
2. 如果没有进行中的冲刺，则更新最近的冲刺待办事项
3. 如果没有关联的冲刺待办事项，则回退到更新UserStory的effort字段

### 前端实现

#### 页面结构
估算功能页面使用 Bootstrap 框架构建，主要包含：
- 面包屑导航
- 响应式表格布局
- 卡片式信息展示
- 模态对话框

#### 交互功能
- AJAX异步提交表单
- 动态刷新页面内容
- 弹出确认对话框
- 响应式设计适配不同屏幕尺寸

## 权限控制

估算功能的权限控制：
- 所有用户都可以参与估算出牌
- 只有管理员可以揭示结果和保存故事点
- 估算列表对所有登录用户可见

## 数据模型关系

估算功能涉及以下数据模型关系：

1. **UserStory 与 GameRound**：一对多关系，一个用户故事可以有多个估算回合
2. **GameRound 与 Estimate**：一对多关系，一个估算回合可以有多个估算记录
3. **User 与 Estimate**：一对多关系，一个用户可以有多条估算记录
4. **UserStory 与 SprintBacklog**：一对多关系，一个用户故事可以关联到多个冲刺待办事项
5. **Sprint 与 SprintBacklog**：一对多关系，一个冲刺可以包含多个待办事项

## 估算流程

完整的估算流程如下：

1. 在估算列表页面选择用户故事，点击"开始估算"
2. 系统创建新的估算回合或进入已有的估算回合
3. 进入估算房间，选择合适的扑克牌并提交
4. 系统跳转到等待页面，等待其他成员完成出牌
5. 当所有成员完成出牌后，自动跳转到揭示结果页面
6. 查看统计信息，如果达成共识，点击保存故事点按钮
7. 确认保存后，故事点数被记录到SprintBacklog中
8. 可以选择开始下一轮估算或返回估算列表

## 注意事项

1. 故事点保存到SprintBacklog的story_points字段，而非UserStory的effort字段
2. 共识算法采用动态阈值，适应不同规模的团队
3. 系统支持估算值为特殊符号（'?', '∞', 'coffee'），但这些值不参与共识计算
4. 估算历史记录可供后续参考和分析
5. **两个不同层级的估算：**
   * effort 存在于用户故事层面，是产品待办列表中的估算
   * story_points 存在于Sprint待办列表中，是具体冲刺计划中的估算