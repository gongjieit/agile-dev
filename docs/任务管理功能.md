# 任务管理功能说明

## 功能概述

任务管理是项目管理系统中的核心功能之一，用于创建、查看、编辑和删除项目中的任务。任务与用户故事关联，通过任务可以跟踪具体的开发工作进度。

## 数据模型

### Task 模型

Task 模型包含以下字段：

1. **task_id**：任务编号，如 TA001，类型为字符串，唯一且可为空
2. **user_story_id**：外键，关联到 UserStory 模型的 id 字段
3. **name**：任务名称，如"周报界面设计"，类型为字符串
4. **description**：任务描述，文本类型，可为空
5. **status**：任务状态，默认为"未开始"，可选值包括"未开始"、"进行中"、"已完成"等
6. **task_type**：任务类型，如"界面设计"、"功能开发"、"功能测试"等
7. **priority**：优先级，默认为"中"，可选值为"高"、"中"、"低"
8. **assignee_id**：外键，关联到 User 模型的 id 字段，表示负责人
9. **start_date**：任务计划开始日期，日期类型
10. **end_date**：任务计划结束日期，日期类型
11. **created_at**：创建时间，默认为当前时间
12. **updated_at**：更新时间，默认为当前时间并会在更新时自动刷新
13. **completed_at**：完成时间，当任务状态变为"已完成"时自动设置

Task 与 User 和 UserStory 模型的关联关系：

1. 通过 assignee 属性关联到 User 模型
2. 通过 user_story 属性关联到 UserStory 模型
3. 在 User 模型中添加了反向引用 assigned_tasks
4. 在 UserStory 模型中添加了反向引用 tasks

## 功能模块

### 1. 任务浏览

用户可以通过以下步骤浏览任务：

1. 选择迭代（Sprint）
2. 选择该迭代下的用户故事（User Story）
3. 查看该用户故事下的所有任务

系统界面以左右分栏的形式展示：
- 左侧显示迭代选择和用户故事列表
- 右侧显示选中用户故事的任务列表

### 2. 任务创建

用户可以为选中的用户故事创建新任务：

1. 点击"添加任务"按钮
2. 在弹出的模态框中填写任务信息：
   - 任务编号（可选，系统可自动生成）
   - 任务名称（必填）
   - 任务描述
   - 状态（默认为"未开始"）
   - 任务类型
   - 优先级
   - 负责人
   - 计划开始日期
   - 计划结束日期
3. 点击"保存"按钮完成创建

任务编号生成规则：
- 格式：TA_[故事编号]_[3位序号]
- 例如：如果故事是US_001_001，则任务编号为TA_US_001_001_001

### 3. 任务编辑

用户可以编辑现有任务：

1. 在任务列表中点击任务的"编辑"按钮
2. 在弹出的编辑模态框中修改任务信息
3. 点击"更新"按钮保存修改

### 4. 任务删除

用户可以删除不需要的任务：

1. 在任务列表中点击任务的"删除"按钮
2. 在确认对话框中确认删除操作

### 5. 状态管理

任务有三种基本状态：
- 未开始
- 进行中
- 已完成

当任务状态变为"已完成"时，系统会自动记录完成时间；当任务从"已完成"状态改回其他状态时，完成时间会被清空。

## 技术实现

### 后端路由

任务管理功能由 `routes/tasks.py` 文件实现，主要包含以下路由：

1. `GET /tasks` - 显示任务管理页面
2. `GET /get_stories_by_sprint/<int:sprint_id>` - 根据迭代ID获取关联的用户故事
3. `GET /get_tasks_by_story/<int:story_id>` - 根据用户故事ID获取关联的任务
4. `POST /add_task/<int:story_id>` - 为用户故事添加任务
5. `POST /edit_task/<int:task_id>` - 编辑任务
6. `POST /delete_task/<int:task_id>` - 删除任务

### 前端实现

前端使用 Bootstrap 框架构建响应式界面，通过 AJAX 与后端进行数据交互。

主要页面元素：
- 迭代选择下拉框
- 用户故事列表
- 任务列表
- 添加任务模态框
- 编辑任务模态框

JavaScript 功能：
- 动态加载迭代下的用户故事
- 动态加载用户故事下的任务
- 表单验证
- 异步提交任务操作

## 权限控制

任务管理功能通过装饰器进行权限控制：
- 用户需要具有 `tasks.tasks` 权限才能访问任务管理页面
- 所有 AJAX 请求都会检查相应权限

## 使用流程

1. 用户进入任务管理页面
2. 选择要操作的迭代
3. 从用户故事列表中选择一个用户故事
4. 查看该用户故事下的任务列表
5. 可以添加新任务、编辑现有任务或删除不需要的任务
6. 所有操作结果会实时反映在界面上

## 特色功能

1. **直观的界面设计** - 采用分栏式布局，便于用户操作
2. **自动编号** - 系统可自动生成符合规范的任务编号
3. **状态自动管理** - 任务状态变更时自动记录完成时间
4. **响应式设计** - 适配不同屏幕尺寸
5. **实时反馈** - 操作结果即时显示，提升用户体验
